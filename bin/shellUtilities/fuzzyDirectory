#!/bin/sh
# Create or switch to an already existing tmux session on a particular directory
# The directory is found by using fzf

# Inspired by The Primeagen
# Reference:
# https://github.com/ThePrimeagen/.dotfiles/blob/master/bin/.local/bin/tmux-sessionizer

# If the script receives just one argument as parameter, then use it as 
# the directory to switch to
if [[ $# -eq 1 ]]; then
	selectedDir=$1
else

source directories.secrets
	# Show all directories (-type d) with a maxdepth of 1 in DIRECTORIES
	# pipe the output to fzf, to pick one single directory
	# the output of fzf is stored in selectedDir
	selectedDir=$(find ${DIRECTORIES} -mindepth 1 -maxdepth 1 -type d | fzf)
fi

# the selected directory variable is empty, exit
if [[ -z $selectedDir ]]; then
	exit 0 
fi

# Change any points '.' for underscores '_' in the basename
# This will be the name of the tmux session
session_name=$(basename "$selectedDir" | tr . _)
# Get PID of tmux
tmux_running=$(pgrep tmux)

if [[ -z $TMUX ]] && [[ -z $tmux_running ]]; then
	# -c = start directory for session
	# -s = session name
	tmux new-session -s ${session_name} -c $selectedDir
	exit 0
fi

# This all takes place if tmux is not already running
# If tmux does not already have a session with the name ${session_name}, it 
# creates one
if ! tmux has-session -t=${session_name} 2> /dev/null; then
	# From 'man tmux': If -d is specified, any other clients attached to the 
	# session are detached.
	tmux new-session -ds ${session_name} -c $selectedDir
fi

# Switch to the session
tmux switch-client -t ${session_name}
